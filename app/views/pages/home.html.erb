<h1>Search Articles</h1>

<input type="text" id="search-box" placeholder="Start typing..." autocomplete="off" />

<p id="status"></p>
<p><a href="/analytics">ðŸ“Š View My Search Analytics</a></p>

<script>
  function debounce(func, delay) {
    let timeout;
    return function(...args) {
      clearTimeout(timeout);
      timeout = setTimeout(() => func.apply(this, args), delay);
    };
  }

  document.addEventListener("turbo:load", () => {
    const searchBox = document.getElementById("search-box");
    const status = document.getElementById("status");

    if (!searchBox) return;

    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

    const sendSearch = debounce((query) => {
      if (query.length <= 2) return;

      fetch("/searches", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRF-Token": csrfToken
        },
        body: JSON.stringify({ query: query })
      }).then((res) => {
        if (res.ok) {
          status.textContent = `Saved: "${query}"`;
        } else {
          status.textContent = `Error saving search`;
        }
      }).catch(() => {
        status.textContent = `Network error`;
      });
    }, 600);

    searchBox.addEventListener("input", (e) => {
      const query = e.target.value.trim();
      sendSearch(query);
    });
  });
</script>
